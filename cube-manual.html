<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml' xml:lang='en' lang='en'>
<head>
<title>Cube Manual</title>
<link type='text/css' href='style.css' rel='stylesheet'/>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<script src="jquery.min.js"></script>
<script src="toc.min.js"></script>
<script type="text/x-mathjax-config">
     MathJax.Hub.Config({
       tex2jax: {
         inlineMath: [['$','$']],
         processEscapes: true
       }
     });
   </script>
   <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML">
   </script>
   </head>
<body>
<div id="content-container">
<div id="toc">
<div id="page-toc">
</div>
<div id="toc-footer"><ul><li><a href="https://github.com/melisgl/mgl-pax">[generated by MGL-PAX]</a></li></ul></div>
</div>
<div id="content">
<p><a id='x-28MGL-CUBE-3A-40CUBE-MANUAL-20MGL-PAX-3ASECTION-29'></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#x-28MGL-CUBE-3A-40CUBE-LINKS-20MGL-PAX-3ASECTION-29" title="Links">&#8594;</a> <a href="#x-28MGL-CUBE-3A-40CUBE-MANUAL-20MGL-PAX-3ASECTION-29" title="Cube Manual">&#8634;</a> <a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L3">&#955;</a></span></span></p>

<h1><a href="#x-28MGL-CUBE-3A-40CUBE-MANUAL-20MGL-PAX-3ASECTION-29">Cube Manual</a></h1>

<h2>Table of Contents</h2>

<ul>
<li><a href="#x-28MGL-CUBE-3A-40CUBE-LINKS-20MGL-PAX-3ASECTION-29" title="Links">1 Links</a></li>
<li><a href="#x-28MGL-CUBE-3A-40CUBE-INTRODUCTION-20MGL-PAX-3ASECTION-29" title="Introduction">2 Introduction</a></li>
<li><a href="#x-28MGL-CUBE-3A-40CUBE-BASICS-20MGL-PAX-3ASECTION-29" title="Basics">3 Basics</a></li>
<li><a href="#x-28MGL-CUBE-3A-40CUBE-SYNCHRONIZATION-20MGL-PAX-3ASECTION-29" title="Synchronization">4 Synchronization</a></li>
<li><a href="#x-28MGL-CUBE-3A-40CUBE-FACETS-20MGL-PAX-3ASECTION-29" title="Facets">5 Facets</a></li>
<li><a href="#x-28MGL-CUBE-3A-40CUBE-FACET-EXTENSION-API-20MGL-PAX-3ASECTION-29" title="Facet Extension API">6 Facet Extension API</a></li>
<li><a href="#x-28MGL-CUBE-3A-40CUBE-DEFAULT-CALL-WITH-FACET-2A-20MGL-PAX-3ASECTION-29" title="The Default Implementation of CALL-WITH-FACET\\*">7 The Default Implementation of CALL-WITH-FACET*</a></li>
<li><a href="#x-28MGL-CUBE-3A-40CUBE-LIFETIME-20MGL-PAX-3ASECTION-29" title="Lifetime">8 Lifetime</a>

<ul>
<li><a href="#x-28MGL-CUBE-3A-40CUBE-FACET-BARRIER-20MGL-PAX-3ASECTION-29" title="Facet Barriers">8.1 Facet Barriers</a></li>
</ul></li>
</ul>

<h6>[in package MGL-CUBE]</h6>

<p><a id='x-28MGL-CUBE-3A-40CUBE-LINKS-20MGL-PAX-3ASECTION-29'></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#x-28MGL-CUBE-3A-40CUBE-MANUAL-20MGL-PAX-3ASECTION-29" title="Cube Manual">&#8592;</a> <a href="#x-28MGL-CUBE-3A-40CUBE-MANUAL-20MGL-PAX-3ASECTION-29" title="Cube Manual">&#8593;</a> <a href="#x-28MGL-CUBE-3A-40CUBE-INTRODUCTION-20MGL-PAX-3ASECTION-29" title="Introduction">&#8594;</a> <a href="#x-28MGL-CUBE-3A-40CUBE-LINKS-20MGL-PAX-3ASECTION-29" title="Links">&#8634;</a> <a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L13">&#955;</a></span></span></p>

<h2><a href="#x-28MGL-CUBE-3A-40CUBE-LINKS-20MGL-PAX-3ASECTION-29">1 Links</a></h2>

<p>Here is the <a href="https://github.com/melisgl/mgl-mat" >official
repository</a> and the <a href="http://melisgl.github.io/mgl-mat/cube-manual.html" >HTML
documentation</a>
for the latest version.</p>

<p><a id='x-28MGL-CUBE-3A-40CUBE-INTRODUCTION-20MGL-PAX-3ASECTION-29'></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#x-28MGL-CUBE-3A-40CUBE-LINKS-20MGL-PAX-3ASECTION-29" title="Links">&#8592;</a> <a href="#x-28MGL-CUBE-3A-40CUBE-MANUAL-20MGL-PAX-3ASECTION-29" title="Cube Manual">&#8593;</a> <a href="#x-28MGL-CUBE-3A-40CUBE-BASICS-20MGL-PAX-3ASECTION-29" title="Basics">&#8594;</a> <a href="#x-28MGL-CUBE-3A-40CUBE-INTRODUCTION-20MGL-PAX-3ASECTION-29" title="Introduction">&#8634;</a> <a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L19">&#955;</a></span></span></p>

<h2><a href="#x-28MGL-CUBE-3A-40CUBE-INTRODUCTION-20MGL-PAX-3ASECTION-29">2 Introduction</a></h2>

<p>This is the library on which MGL-MAT (see <a href="mat-manual.html#x-28MGL-MAT-3A-40MAT-MANUAL-20MGL-PAX-3ASECTION-29" title="MAT Manual">MAT Manual</a>) is
built. The idea of automatically translating between various
representations may be useful for other applications, so this got
its own package and all ties to MGL-MAT has been severed.</p>

<p>This package defines <a href="#x-28MGL-CUBE-3ACUBE-20CLASS-29" title="(MGL-CUBE:CUBE CLASS)"><code>CUBE</code></a>, an abstract base class that provides a
framework for automatic conversion between various representations
of the same data. To define a cube, <a href="#x-28MGL-CUBE-3ACUBE-20CLASS-29" title="(MGL-CUBE:CUBE CLASS)"><code>CUBE</code></a> needs to be subclassed and
the <a href="#x-28MGL-CUBE-3A-40CUBE-FACET-EXTENSION-API-20MGL-PAX-3ASECTION-29" title="Facet Extension API">Facet Extension API</a> be implemented.</p>

<p>If you are only interested in how to use cubes in general, read
<a href="#x-28MGL-CUBE-3A-40CUBE-BASICS-20MGL-PAX-3ASECTION-29" title="Basics">Basics</a>, <a href="#x-28MGL-CUBE-3A-40CUBE-LIFETIME-20MGL-PAX-3ASECTION-29" title="Lifetime">Lifetime</a> and <a href="#x-28MGL-CUBE-3A-40CUBE-FACET-BARRIER-20MGL-PAX-3ASECTION-29" title="Facet Barriers">Facet Barriers</a>.</p>

<p>If you want to implement a new cube datatype, then see <a href="#x-28MGL-CUBE-3A-40CUBE-FACETS-20MGL-PAX-3ASECTION-29" title="Facets">Facets</a>,
<a href="#x-28MGL-CUBE-3A-40CUBE-FACET-EXTENSION-API-20MGL-PAX-3ASECTION-29" title="Facet Extension API">Facet Extension API</a>, and <a href="#x-28MGL-CUBE-3A-40CUBE-DEFAULT-CALL-WITH-FACET-2A-20MGL-PAX-3ASECTION-29" title="The Default Implementation of CALL-WITH-FACET\\*">The Default Implementation of CALL-WITH-FACET*</a>.</p>

<p><a id='x-28MGL-CUBE-3A-40CUBE-BASICS-20MGL-PAX-3ASECTION-29'></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#x-28MGL-CUBE-3A-40CUBE-INTRODUCTION-20MGL-PAX-3ASECTION-29" title="Introduction">&#8592;</a> <a href="#x-28MGL-CUBE-3A-40CUBE-MANUAL-20MGL-PAX-3ASECTION-29" title="Cube Manual">&#8593;</a> <a href="#x-28MGL-CUBE-3A-40CUBE-SYNCHRONIZATION-20MGL-PAX-3ASECTION-29" title="Synchronization">&#8594;</a> <a href="#x-28MGL-CUBE-3A-40CUBE-BASICS-20MGL-PAX-3ASECTION-29" title="Basics">&#8634;</a> <a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L72">&#955;</a></span></span></p>

<h2><a href="#x-28MGL-CUBE-3A-40CUBE-BASICS-20MGL-PAX-3ASECTION-29">3 Basics</a></h2>

<p>Here we learn what a <a href="#x-28MGL-CUBE-3ACUBE-20CLASS-29" title="(MGL-CUBE:CUBE CLASS)"><code>CUBE</code></a> is and how to access the data in it with
<a href="#x-28MGL-CUBE-3AWITH-FACET-20-28MGL-PAX-3AMACRO-29-29" title="(MGL-CUBE:WITH-FACET (MGL-PAX:MACRO))"><code>WITH-FACET</code></a>.</p>

<p><a id='x-28MGL-CUBE-3ACUBE-20CLASS-29'></a></p>

<ul>
<li><p><span class="locative-type"><a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L103">[class]</a></span> <span class="reference-object"><a href="#x-28MGL-CUBE-3ACUBE-20CLASS-29" >CUBE</a></span></p>

<p>A datacube that has various representations of the
same stuff. These representations go by the name `facet'. Clients
must use <a href="#x-28MGL-CUBE-3AWITH-FACET-20-28MGL-PAX-3AMACRO-29-29" title="(MGL-CUBE:WITH-FACET (MGL-PAX:MACRO))"><code>WITH-FACET</code></a> to acquire a dynamic extent reference to a
facet. With the information provided in the <a href="#x-28MGL-CUBE-3ADIRECTION-20-28TYPE-29-29" title="(MGL-CUBE:DIRECTION (TYPE))"><code>DIRECTION</code></a> argument of
<a href="#x-28MGL-CUBE-3AWITH-FACET-20-28MGL-PAX-3AMACRO-29-29" title="(MGL-CUBE:WITH-FACET (MGL-PAX:MACRO))"><code>WITH-FACET</code></a>, the cube keeps track of which facets are up-to-date and
copies data between them as necessary.</p>

<p>The cube is an abstract class, it does not provide useful behavior
in itself. One must subclass it and implement the
<a href="#x-28MGL-CUBE-3A-40CUBE-FACET-EXTENSION-API-20MGL-PAX-3ASECTION-29" title="Facet Extension API">Facet Extension API</a>.</p>

<p>Also see <a href="#x-28MGL-CUBE-3A-40CUBE-LIFETIME-20MGL-PAX-3ASECTION-29" title="Lifetime">Lifetime</a> and <a href="#x-28MGL-CUBE-3A-40CUBE-FACET-BARRIER-20MGL-PAX-3ASECTION-29" title="Facet Barriers">Facet Barriers</a>.</p></li>
</ul>

<p><a id='x-28MGL-CUBE-3AWITH-FACET-20-28MGL-PAX-3AMACRO-29-29'></a></p>

<ul>
<li><p><span class="locative-type"><a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L163">[macro]</a></span> <span class="reference-object"><a href="#x-28MGL-CUBE-3AWITH-FACET-20-28MGL-PAX-3AMACRO-29-29" >WITH-FACET</a></span> <span class="locative-args">(VAR (CUBE FACET-NAME &amp;KEY (DIRECTION <code>:IO</code>) TYPE)) &amp;BODY BODY</span></p>

<p>Find or create the facet with <code>FACET-NAME</code> in <code>CUBE</code> and bind <code>VAR</code> to
the representation of <code>CUBE</code>'s data provided by that facet. This
representation is called the facet's <em>value</em>. The value is to be
treated as dynamic extent: it is not allowed to keep a reference to
it. For the description of the <code>DIRECTION</code> parameter, see the type
<code>DIRECTION</code>.</p>

<p>If <code>TYPE</code> is specified, then <code>VAR</code> is declared to be of that type.</p></li>
</ul>

<p><a id='x-28MGL-CUBE-3ADIRECTION-20-28TYPE-29-29'></a></p>

<ul>
<li><p><span class="locative-type"><a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L178">[type]</a></span> <span class="reference-object"><a href="#x-28MGL-CUBE-3ADIRECTION-20-28TYPE-29-29" >DIRECTION</a></span></p>

<p>Used by <a href="#x-28MGL-CUBE-3AWITH-FACET-20-28MGL-PAX-3AMACRO-29-29" title="(MGL-CUBE:WITH-FACET (MGL-PAX:MACRO))"><code>WITH-FACET</code></a>, <code>DIRECTION</code> can be <code>:INPUT</code>, <code>:OUTPUT</code> or <code>:IO</code>.</p>

<ul>
<li><p><code>:INPUT</code> promises that the facet will only be read and never
  written. Other up-to-date facets of the same cube remain
  up-to-date. If the facet in question is not up-to-date then data
  is copied to it from one of the up-to-date facets (see
  <a href="#x-28MGL-CUBE-3ASELECT-COPY-SOURCE-FOR-FACET-2A-20GENERIC-FUNCTION-29" title="(MGL-CUBE:SELECT-COPY-SOURCE-FOR-FACET* GENERIC-FUNCTION)"><code>SELECT-COPY-SOURCE-FOR-FACET*</code></a>).</p></li>
<li><p><code>:OUTPUT</code> promises that <em>all</em> data will be overwritten without
  reading any data. All up-to-date facets become non-up-to-date,
  while this facet is marked as up-to-date. No copying of data takes
  place.</p></li>
<li><p><code>:IO</code> promises nothing about the type of access. All up-to-date
  facets become non-up-to-date, while this facet is marked as
  up-to-date. If the facet in question is not up-to-date then data
  is copied to it from one of the up-to-date facets (see
  <a href="#x-28MGL-CUBE-3ASELECT-COPY-SOURCE-FOR-FACET-2A-20GENERIC-FUNCTION-29" title="(MGL-CUBE:SELECT-COPY-SOURCE-FOR-FACET* GENERIC-FUNCTION)"><code>SELECT-COPY-SOURCE-FOR-FACET*</code></a>).</p></li>
</ul>

<p>Any number of <a href="#x-28MGL-CUBE-3AWITH-FACET-20-28MGL-PAX-3AMACRO-29-29" title="(MGL-CUBE:WITH-FACET (MGL-PAX:MACRO))"><code>WITH-FACET</code></a>s with direction <code>:INPUT</code> may be active at
the same time, but <code>:IO</code> and <code>:OUTPUT</code> cannot coexists with another
<a href="#x-28MGL-CUBE-3AWITH-FACET-20-28MGL-PAX-3AMACRO-29-29" title="(MGL-CUBE:WITH-FACET (MGL-PAX:MACRO))"><code>WITH-FACET</code></a> regardless of the direction. The exception for this rule
is that an inner <a href="#x-28MGL-CUBE-3AWITH-FACET-20-28MGL-PAX-3AMACRO-29-29" title="(MGL-CUBE:WITH-FACET (MGL-PAX:MACRO))"><code>WITH-FACET</code></a> does not conflict with an enclosing
<a href="#x-28MGL-CUBE-3AWITH-FACET-20-28MGL-PAX-3AMACRO-29-29" title="(MGL-CUBE:WITH-FACET (MGL-PAX:MACRO))"><code>WITH-FACET</code></a> if they are for the same facet (but inner <a href="#x-28MGL-CUBE-3AWITH-FACET-20-28MGL-PAX-3AMACRO-29-29" title="(MGL-CUBE:WITH-FACET (MGL-PAX:MACRO))"><code>WITH-FACET</code></a>s
for another facet or for the same facet from another thread do).</p>

<p>See <a href="#x-28MGL-CUBE-3ACHECK-NO-WRITERS-20FUNCTION-29" title="(MGL-CUBE:CHECK-NO-WRITERS FUNCTION)"><code>CHECK-NO-WRITERS</code></a> and <a href="#x-28MGL-CUBE-3ACHECK-NO-WATCHERS-20FUNCTION-29" title="(MGL-CUBE:CHECK-NO-WATCHERS FUNCTION)"><code>CHECK-NO-WATCHERS</code></a> called by
<a href="#x-28MGL-CUBE-3A-40CUBE-DEFAULT-CALL-WITH-FACET-2A-20MGL-PAX-3ASECTION-29" title="The Default Implementation of CALL-WITH-FACET\\*">The Default Implementation of CALL-WITH-FACET*</a>.</p></li>
</ul>

<p><a id='x-28MGL-CUBE-3AWITH-FACETS-20-28MGL-PAX-3AMACRO-29-29'></a></p>

<ul>
<li><p><span class="locative-type"><a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L215">[macro]</a></span> <span class="reference-object"><a href="#x-28MGL-CUBE-3AWITH-FACETS-20-28MGL-PAX-3AMACRO-29-29" >WITH-FACETS</a></span> <span class="locative-args">(&amp;REST FACET-BINDING-SPECS) &amp;BODY BODY</span></p>

<p>A shorthand for writing nested <a href="#x-28MGL-CUBE-3AWITH-FACET-20-28MGL-PAX-3AMACRO-29-29" title="(MGL-CUBE:WITH-FACET (MGL-PAX:MACRO))"><code>WITH-FACET</code></a> calls.</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">with-facet</span></i> <span class="paren2">(<span class="code">f1 <span class="paren3">(<span class="code">c1 'name1 <span class="keyword">:direction</span> <span class="keyword">:input</span></span>)</span></span>)</span>
  <span class="paren2">(<span class="code"><i><span class="symbol">with-facet</span></i> <span class="paren3">(<span class="code">f2 <span class="paren4">(<span class="code">c2 'name2 <span class="keyword">:direction</span> <span class="keyword">:output</span></span>)</span></span>)</span>
    ...</span>)</span></span>)</span></span></code></pre>

<p>is equivalent to:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">with-facets</span></i> <span class="paren2">(<span class="code"><span class="paren3">(<span class="code">f1 <span class="paren4">(<span class="code">c1 'name1 <span class="keyword">:direction</span> <span class="keyword">:input</span></span>)</span></span>)</span>
              <span class="paren3">(<span class="code">f2 <span class="paren4">(<span class="code">c2 'name2 <span class="keyword">:direction</span> <span class="keyword">:output</span></span>)</span></span>)</span></span>)</span>
  ...</span>)</span></span></code></pre></li>
</ul>

<p><a id='x-28MGL-CUBE-3A-40CUBE-SYNCHRONIZATION-20MGL-PAX-3ASECTION-29'></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#x-28MGL-CUBE-3A-40CUBE-BASICS-20MGL-PAX-3ASECTION-29" title="Basics">&#8592;</a> <a href="#x-28MGL-CUBE-3A-40CUBE-MANUAL-20MGL-PAX-3ASECTION-29" title="Cube Manual">&#8593;</a> <a href="#x-28MGL-CUBE-3A-40CUBE-FACETS-20MGL-PAX-3ASECTION-29" title="Facets">&#8594;</a> <a href="#x-28MGL-CUBE-3A-40CUBE-SYNCHRONIZATION-20MGL-PAX-3ASECTION-29" title="Synchronization">&#8634;</a> <a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L80">&#955;</a></span></span></p>

<h2><a href="#x-28MGL-CUBE-3A-40CUBE-SYNCHRONIZATION-20MGL-PAX-3ASECTION-29">4 Synchronization</a></h2>

<p>Cubes keep track of which facets are used, which are up-to-date to
be able to perform automatic translation between facets. <a href="#x-28MGL-CUBE-3AWITH-FACET-20-28MGL-PAX-3AMACRO-29-29" title="(MGL-CUBE:WITH-FACET (MGL-PAX:MACRO))"><code>WITH-FACET</code></a>
and other operations access and make changes to this metadata so
thread safety is a concern. In this section, we detail how to relax
the default thread safety guarantees.</p>

<p>A related concern is async signal safety which arises most often
when C-c'ing or killing a thread or when the extremely nasty
WITH-TIMEOUT macro is used. In a nutshell, changes to cube metadata
are always made with interrupts disabled so things should be async
signal safe.</p>

<p><a id='x-28MGL-CUBE-3ASYNCHRONIZATION-20-28MGL-PAX-3AACCESSOR-20MGL-CUBE-3ACUBE-29-29'></a></p>

<ul>
<li><p><span class="locative-type"><a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L104">[accessor]</a></span> <span class="reference-object"><a href="#x-28MGL-CUBE-3ASYNCHRONIZATION-20-28MGL-PAX-3AACCESSOR-20MGL-CUBE-3ACUBE-29-29" >SYNCHRONIZATION</a></span> <span class="locative-args">CUBE</span> <span class="locative-args">(:SYNCHRONIZATION = <a href="#x-28MGL-CUBE-3A-2ADEFAULT-SYNCHRONIZATION-2A-20-28VARIABLE-29-29" title="(MGL-CUBE:*DEFAULT-SYNCHRONIZATION* (VARIABLE))"><code>*DEFAULT-SYNCHRONIZATION*</code></a>)</span></p>

<p>By default, setup and teardown of facets by
<a href="#x-28MGL-CUBE-3AWITH-FACET-20-28MGL-PAX-3AMACRO-29-29" title="(MGL-CUBE:WITH-FACET (MGL-PAX:MACRO))"><code>WITH-FACET</code></a> is performed in a thread safe way. Corrupting internal
data structures of cubes is not fun, but in the name of
performance, synchronization can be turned off either dynamically
or on a per instance basis.</p>

<p>If <code>T</code>, then access to cube metadata is always synchronized. If <code>NIL</code>,
then never. If <code>:MAYBE</code>, then whether access is synchronized is
determined by <a href="#x-28MGL-CUBE-3A-2AMAYBE-SYNCHRONIZE-CUBE-2A-20-28VARIABLE-29-29" title="(MGL-CUBE:*MAYBE-SYNCHRONIZE-CUBE* (VARIABLE))"><code>*MAYBE-SYNCHRONIZE-CUBE*</code></a> that's true by default.</p>

<p>The default is the value of <a href="#x-28MGL-CUBE-3A-2ADEFAULT-SYNCHRONIZATION-2A-20-28VARIABLE-29-29" title="(MGL-CUBE:*DEFAULT-SYNCHRONIZATION* (VARIABLE))"><code>*DEFAULT-SYNCHRONIZATION*</code></a>
that's <code>:MAYBE</code> by default.</p>

<p>Note that the body of a <a href="#x-28MGL-CUBE-3AWITH-FACET-20-28MGL-PAX-3AMACRO-29-29" title="(MGL-CUBE:WITH-FACET (MGL-PAX:MACRO))"><code>WITH-FACET</code></a> is never synchronized with
anyone, apart from the implicit reader/writer conflict (see
<a href="#x-28MGL-CUBE-3ADIRECTION-20-28TYPE-29-29" title="(MGL-CUBE:DIRECTION (TYPE))"><code>DIRECTION</code></a>).</p></li>
</ul>

<p><a id='x-28MGL-CUBE-3A-2ADEFAULT-SYNCHRONIZATION-2A-20-28VARIABLE-29-29'></a></p>

<ul>
<li><p><span class="locative-type"><a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L96">[variable]</a></span> <span class="reference-object"><a href="#x-28MGL-CUBE-3A-2ADEFAULT-SYNCHRONIZATION-2A-20-28VARIABLE-29-29" >*DEFAULT-SYNCHRONIZATION*</a></span> <span class="locative-args">:MAYBE</span></p>

<p>The default value for <a href="#x-28MGL-CUBE-3ASYNCHRONIZATION-20-28MGL-PAX-3AACCESSOR-20MGL-CUBE-3ACUBE-29-29" title="(MGL-CUBE:SYNCHRONIZATION (MGL-PAX:ACCESSOR MGL-CUBE:CUBE))"><code>SYNCHRONIZATION</code></a> of new cubes.</p></li>
</ul>

<p><a id='x-28MGL-CUBE-3A-2AMAYBE-SYNCHRONIZE-CUBE-2A-20-28VARIABLE-29-29'></a></p>

<ul>
<li><p><span class="locative-type"><a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L99">[variable]</a></span> <span class="reference-object"><a href="#x-28MGL-CUBE-3A-2AMAYBE-SYNCHRONIZE-CUBE-2A-20-28VARIABLE-29-29" >*MAYBE-SYNCHRONIZE-CUBE*</a></span> <span class="locative-args">T</span></p>

<p>Determines whether access the cube metadata is synchronized for
cubes with <a href="#x-28MGL-CUBE-3ASYNCHRONIZATION-20-28MGL-PAX-3AACCESSOR-20MGL-CUBE-3ACUBE-29-29" title="(MGL-CUBE:SYNCHRONIZATION (MGL-PAX:ACCESSOR MGL-CUBE:CUBE))"><code>SYNCHRONIZATION</code></a> <code>:MAYBE</code>.</p></li>
</ul>

<p><a id='x-28MGL-CUBE-3A-40CUBE-FACETS-20MGL-PAX-3ASECTION-29'></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#x-28MGL-CUBE-3A-40CUBE-SYNCHRONIZATION-20MGL-PAX-3ASECTION-29" title="Synchronization">&#8592;</a> <a href="#x-28MGL-CUBE-3A-40CUBE-MANUAL-20MGL-PAX-3ASECTION-29" title="Cube Manual">&#8593;</a> <a href="#x-28MGL-CUBE-3A-40CUBE-FACET-EXTENSION-API-20MGL-PAX-3ASECTION-29" title="Facet Extension API">&#8594;</a> <a href="#x-28MGL-CUBE-3A-40CUBE-FACETS-20MGL-PAX-3ASECTION-29" title="Facets">&#8634;</a> <a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L234">&#955;</a></span></span></p>

<h2><a href="#x-28MGL-CUBE-3A-40CUBE-FACETS-20MGL-PAX-3ASECTION-29">5 Facets</a></h2>

<p>The basic currency for implementing new cube types is the <a href="#x-28MGL-CUBE-3AFACET-20CLASS-29" title="(MGL-CUBE:FACET CLASS)"><code>FACET</code></a>.
Simply using a cube only involves facet names and values, never
facets themselves.</p>

<p><a id='x-28MGL-CUBE-3AFACETS-20FUNCTION-29'></a></p>

<ul>
<li><p><span class="locative-type"><a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L249">[function]</a></span> <span class="reference-object"><a href="#x-28MGL-CUBE-3AFACETS-20FUNCTION-29" >FACETS</a></span> <span class="locative-args">CUBE</span></p>

<p>Return the facets of <code>CUBE</code>.</p></li>
</ul>

<p><a id='x-28MGL-CUBE-3AFIND-FACET-20FUNCTION-29'></a></p>

<ul>
<li><p><span class="locative-type"><a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L253">[function]</a></span> <span class="reference-object"><a href="#x-28MGL-CUBE-3AFIND-FACET-20FUNCTION-29" >FIND-FACET</a></span> <span class="locative-args">CUBE FACET-NAME</span></p>

<p>Return the facet of <code>CUBE</code> for the facet with <code>FACET-NAME</code> or <code>NIL</code> if no
such facet exists.</p></li>
</ul>

<p><a id='x-28MGL-CUBE-3AFACET-20CLASS-29'></a></p>

<ul>
<li><p><span class="locative-type"><a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L258">[class]</a></span> <span class="reference-object"><a href="#x-28MGL-CUBE-3AFACET-20CLASS-29" >FACET</a></span> <span class="locative-args">STRUCTURE-OBJECT</span></p>

<p>A cube has facets, as we discussed in <a href="#x-28MGL-CUBE-3A-40CUBE-BASICS-20MGL-PAX-3ASECTION-29" title="Basics">Basics</a>. Facets holds
the data in a particular representation, this is called the <em>value</em>
of the facet. A facet holds one such value and some metadata
pertaining to it: its <code>FACET-NAME</code>(<a href="#x-28MGL-CUBE-3AFACET-NAME-20-28MGL-PAX-3ALOCATIVE-29-29" title="(MGL-CUBE:FACET-NAME (MGL-PAX:LOCATIVE))"><code>0</code></a> <a href="#x-28MGL-CUBE-3AFACET-NAME-20-28MGL-PAX-3ASTRUCTURE-ACCESSOR-29-29" title="(MGL-CUBE:FACET-NAME (MGL-PAX:STRUCTURE-ACCESSOR))"><code>1</code></a>), whether it's
up-to-date (<a href="#x-28MGL-CUBE-3AFACET-UP-TO-DATE-P-20-28MGL-PAX-3ASTRUCTURE-ACCESSOR-29-29" title="(MGL-CUBE:FACET-UP-TO-DATE-P (MGL-PAX:STRUCTURE-ACCESSOR))"><code>FACET-UP-TO-DATE-P</code></a>), etc. <code>FACET</code> objects are never seen
when simply using a cube, they are for implementing the
<a href="#x-28MGL-CUBE-3A-40CUBE-FACET-EXTENSION-API-20MGL-PAX-3ASECTION-29" title="Facet Extension API">Facet Extension API</a>.</p></li>
</ul>

<p><a id='x-28MGL-CUBE-3AFACET-NAME-20-28MGL-PAX-3ASTRUCTURE-ACCESSOR-29-29'></a></p>

<ul>
<li><p><span class="locative-type"><a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L258">[structure-accessor]</a></span> <span class="reference-object"><a href="#x-28MGL-CUBE-3AFACET-NAME-20-28MGL-PAX-3ASTRUCTURE-ACCESSOR-29-29" >FACET-NAME</a></span></p>

<p>A symbol that uniquely identifies the facet within a cube.</p></li>
</ul>

<p><a id='x-28MGL-CUBE-3AFACET-VALUE-20-28MGL-PAX-3ASTRUCTURE-ACCESSOR-29-29'></a></p>

<ul>
<li><p><span class="locative-type"><a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L258">[structure-accessor]</a></span> <span class="reference-object"><a href="#x-28MGL-CUBE-3AFACET-VALUE-20-28MGL-PAX-3ASTRUCTURE-ACCESSOR-29-29" >FACET-VALUE</a></span></p>

<p>This is what's normally exposed by <a href="#x-28MGL-CUBE-3AWITH-FACET-20-28MGL-PAX-3AMACRO-29-29" title="(MGL-CUBE:WITH-FACET (MGL-PAX:MACRO))"><code>WITH-FACET</code></a>.</p></li>
</ul>

<p><a id='x-28MGL-CUBE-3AFACET-DESCRIPTION-20-28MGL-PAX-3ASTRUCTURE-ACCESSOR-29-29'></a></p>

<ul>
<li><p><span class="locative-type"><a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L258">[structure-accessor]</a></span> <span class="reference-object"><a href="#x-28MGL-CUBE-3AFACET-DESCRIPTION-20-28MGL-PAX-3ASTRUCTURE-ACCESSOR-29-29" >FACET-DESCRIPTION</a></span></p>

<p>Returned by <a href="#x-28MGL-CUBE-3AMAKE-FACET-2A-20GENERIC-FUNCTION-29" title="(MGL-CUBE:MAKE-FACET* GENERIC-FUNCTION)"><code>MAKE-FACET*</code></a> as its second value, this is an
arbitrary object in which additional information can be
stored.</p></li>
</ul>

<p><a id='x-28MGL-CUBE-3AFACET-UP-TO-DATE-P-20-28MGL-PAX-3ASTRUCTURE-ACCESSOR-29-29'></a></p>

<ul>
<li><p><span class="locative-type"><a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L258">[structure-accessor]</a></span> <span class="reference-object"><a href="#x-28MGL-CUBE-3AFACET-UP-TO-DATE-P-20-28MGL-PAX-3ASTRUCTURE-ACCESSOR-29-29" >FACET-UP-TO-DATE-P</a></span></p>

<p>Whether the cube has changed since this facet has been last
updated. See <a href="#x-28MGL-CUBE-3AFACET-UP-TO-DATE-P-2A-20GENERIC-FUNCTION-29" title="(MGL-CUBE:FACET-UP-TO-DATE-P* GENERIC-FUNCTION)"><code>FACET-UP-TO-DATE-P*</code></a>.</p></li>
</ul>

<p><a id='x-28MGL-CUBE-3AFACET-N-WATCHERS-20-28MGL-PAX-3ASTRUCTURE-ACCESSOR-29-29'></a></p>

<ul>
<li><p><span class="locative-type"><a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L258">[structure-accessor]</a></span> <span class="reference-object"><a href="#x-28MGL-CUBE-3AFACET-N-WATCHERS-20-28MGL-PAX-3ASTRUCTURE-ACCESSOR-29-29" >FACET-N-WATCHERS</a></span></p>

<p>The number of active <a href="#x-28MGL-CUBE-3AWITH-FACET-20-28MGL-PAX-3AMACRO-29-29" title="(MGL-CUBE:WITH-FACET (MGL-PAX:MACRO))"><code>WITH-FACET</code></a>s. Updated by <a href="#x-28MGL-CUBE-3AWATCH-FACET-20GENERIC-FUNCTION-29" title="(MGL-CUBE:WATCH-FACET GENERIC-FUNCTION)"><code>WATCH-FACET</code></a> and
<a href="#x-28MGL-CUBE-3AUNWATCH-FACET-20GENERIC-FUNCTION-29" title="(MGL-CUBE:UNWATCH-FACET GENERIC-FUNCTION)"><code>UNWATCH-FACET</code></a>.</p></li>
</ul>

<p><a id='x-28MGL-CUBE-3AFACET-WATCHER-THREADS-20-28MGL-PAX-3ASTRUCTURE-ACCESSOR-29-29'></a></p>

<ul>
<li><p><span class="locative-type"><a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L258">[structure-accessor]</a></span> <span class="reference-object"><a href="#x-28MGL-CUBE-3AFACET-WATCHER-THREADS-20-28MGL-PAX-3ASTRUCTURE-ACCESSOR-29-29" >FACET-WATCHER-THREADS</a></span></p>

<p>The threads (one for each watcher) that have active
<a href="#x-28MGL-CUBE-3AWITH-FACET-20-28MGL-PAX-3AMACRO-29-29" title="(MGL-CUBE:WITH-FACET (MGL-PAX:MACRO))"><code>WITH-FACET</code></a>s.</p></li>
</ul>

<p><a id='x-28MGL-CUBE-3AFACET-DIRECTION-20-28MGL-PAX-3ASTRUCTURE-ACCESSOR-29-29'></a></p>

<ul>
<li><p><span class="locative-type"><a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L258">[structure-accessor]</a></span> <span class="reference-object"><a href="#x-28MGL-CUBE-3AFACET-DIRECTION-20-28MGL-PAX-3ASTRUCTURE-ACCESSOR-29-29" >FACET-DIRECTION</a></span></p>

<p>The direction of the last <a href="#x-28MGL-CUBE-3AWITH-FACET-20-28MGL-PAX-3AMACRO-29-29" title="(MGL-CUBE:WITH-FACET (MGL-PAX:MACRO))"><code>WITH-FACET</code></a> on this facet.</p></li>
</ul>

<p><a id='x-28MGL-CUBE-3A-40CUBE-FACET-EXTENSION-API-20MGL-PAX-3ASECTION-29'></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#x-28MGL-CUBE-3A-40CUBE-FACETS-20MGL-PAX-3ASECTION-29" title="Facets">&#8592;</a> <a href="#x-28MGL-CUBE-3A-40CUBE-MANUAL-20MGL-PAX-3ASECTION-29" title="Cube Manual">&#8593;</a> <a href="#x-28MGL-CUBE-3A-40CUBE-DEFAULT-CALL-WITH-FACET-2A-20MGL-PAX-3ASECTION-29" title="The Default Implementation of CALL-WITH-FACET\\*">&#8594;</a> <a href="#x-28MGL-CUBE-3A-40CUBE-FACET-EXTENSION-API-20MGL-PAX-3ASECTION-29" title="Facet Extension API">&#8634;</a> <a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L314">&#955;</a></span></span></p>

<h2><a href="#x-28MGL-CUBE-3A-40CUBE-FACET-EXTENSION-API-20MGL-PAX-3ASECTION-29">6 Facet Extension API</a></h2>

<p>Many of the generic functions in this section take <a href="#x-28MGL-CUBE-3AFACET-20CLASS-29" title="(MGL-CUBE:FACET CLASS)"><code>FACET</code></a> arguments.
<a href="#x-28MGL-CUBE-3AFACET-20CLASS-29" title="(MGL-CUBE:FACET CLASS)"><code>FACET</code></a> is a structure and is not intended to be subclassed. To be
able to add specialized methods, the name of the
facet (<a href="#x-28MGL-CUBE-3AFACET-NAME-20-28MGL-PAX-3ASTRUCTURE-ACCESSOR-29-29" title="(MGL-CUBE:FACET-NAME (MGL-PAX:STRUCTURE-ACCESSOR))"><code>FACET-NAME</code></a>) is also passed as the
argument right in front of the corresponding facet argument.</p>

<p>In summary, define <code>EQL</code> specializers on facet name arguments, and use
<a href="#x-28MGL-CUBE-3AFACET-DESCRIPTION-20-28MGL-PAX-3ASTRUCTURE-ACCESSOR-29-29" title="(MGL-CUBE:FACET-DESCRIPTION (MGL-PAX:STRUCTURE-ACCESSOR))"><code>FACET-DESCRIPTION</code></a> to associate arbitrary information with facets.</p>

<p><a id='x-28MGL-CUBE-3AMAKE-FACET-2A-20GENERIC-FUNCTION-29'></a></p>

<ul>
<li><p><span class="locative-type"><a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L335">[generic-function]</a></span> <span class="reference-object"><a href="#x-28MGL-CUBE-3AMAKE-FACET-2A-20GENERIC-FUNCTION-29" >MAKE-FACET*</a></span> <span class="locative-args">CUBE FACET-NAME</span></p>

<p>Called by <a href="#x-28MGL-CUBE-3AWITH-FACET-20-28MGL-PAX-3AMACRO-29-29" title="(MGL-CUBE:WITH-FACET (MGL-PAX:MACRO))"><code>WITH-FACET</code></a> (or more directly <a href="#x-28MGL-CUBE-3AWATCH-FACET-20GENERIC-FUNCTION-29" title="(MGL-CUBE:WATCH-FACET GENERIC-FUNCTION)"><code>WATCH-FACET</code></a>)
when there is no facet with <code>FACET-NAME</code>. As the first value, return a
new object capable of storing <code>CUBE</code>'s data in the facet with
<code>FACET-NAME</code>. As the second value, return a facet description which
will be available as <a href="#x-28MGL-CUBE-3AFACET-DESCRIPTION-20-28MGL-PAX-3ASTRUCTURE-ACCESSOR-29-29" title="(MGL-CUBE:FACET-DESCRIPTION (MGL-PAX:STRUCTURE-ACCESSOR))"><code>FACET-DESCRIPTION</code></a>. As the third value, return a
generalized boolean indicating whether this facet must be explicitly
destroyed (in which case a finalizer will be added to <code>CUBE</code>).</p></li>
</ul>

<p><a id='x-28MGL-CUBE-3ADESTROY-FACET-2A-20GENERIC-FUNCTION-29'></a></p>

<ul>
<li><p><span class="locative-type"><a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L344">[generic-function]</a></span> <span class="reference-object"><a href="#x-28MGL-CUBE-3ADESTROY-FACET-2A-20GENERIC-FUNCTION-29" >DESTROY-FACET*</a></span> <span class="locative-args">FACET-NAME FACET</span></p>

<p>Free the resources associated with <code>FACET</code> with
<code>FACET-NAME</code>. The cube this facet belongs to is not among the
parameters because this method can be called from a finalizer on the
cube (so we can't have a reference to the cube portably) which also
means that it may run in an unpredictable thread.</p></li>
</ul>

<p><a id='x-28MGL-CUBE-3ACOPY-FACET-2A-20GENERIC-FUNCTION-29'></a></p>

<ul>
<li><p><span class="locative-type"><a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L351">[generic-function]</a></span> <span class="reference-object"><a href="#x-28MGL-CUBE-3ACOPY-FACET-2A-20GENERIC-FUNCTION-29" >COPY-FACET*</a></span> <span class="locative-args">CUBE FROM-FACET-NAME FROM-FACET TO-FACET-NAME TO-FACET</span></p>

<p>Copy the <code>CUBE</code>'s data from <code>FROM-FACET</code> with
<code>FROM-FACET-NAME</code> to <code>TO-FACET</code> with <code>TO-FACET-NAME</code>. Called by
<a href="#x-28MGL-CUBE-3AWITH-FACET-20-28MGL-PAX-3AMACRO-29-29" title="(MGL-CUBE:WITH-FACET (MGL-PAX:MACRO))"><code>WITH-FACET</code></a> (or more directly <a href="#x-28MGL-CUBE-3AWATCH-FACET-20GENERIC-FUNCTION-29" title="(MGL-CUBE:WATCH-FACET GENERIC-FUNCTION)"><code>WATCH-FACET</code></a>) when necessary. <code>FROM-FACET</code>
is what <a href="#x-28MGL-CUBE-3ASELECT-COPY-SOURCE-FOR-FACET-2A-20GENERIC-FUNCTION-29" title="(MGL-CUBE:SELECT-COPY-SOURCE-FOR-FACET* GENERIC-FUNCTION)"><code>SELECT-COPY-SOURCE-FOR-FACET*</code></a> returned.</p></li>
</ul>

<p><a id='x-28MGL-CUBE-3ACALL-WITH-FACET-2A-20GENERIC-FUNCTION-29'></a></p>

<ul>
<li><p><span class="locative-type"><a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L382">[generic-function]</a></span> <span class="reference-object"><a href="#x-28MGL-CUBE-3ACALL-WITH-FACET-2A-20GENERIC-FUNCTION-29" >CALL-WITH-FACET*</a></span> <span class="locative-args">CUBE FACET-NAME DIRECTION FN</span></p>

<p>Call <code>FN</code> with an up-to-date <a href="#x-28MGL-CUBE-3AFACET-VALUE-20-28MGL-PAX-3ASTRUCTURE-ACCESSOR-29-29" title="(MGL-CUBE:FACET-VALUE (MGL-PAX:STRUCTURE-ACCESSOR))"><code>FACET-VALUE</code></a> that belongs
to <code>FACET-NAME</code> of <code>CUBE</code>. <a href="#x-28MGL-CUBE-3AWITH-FACET-20-28MGL-PAX-3AMACRO-29-29" title="(MGL-CUBE:WITH-FACET (MGL-PAX:MACRO))"><code>WITH-FACET</code></a> is directly implemented in terms
of this function. See <a href="#x-28MGL-CUBE-3A-40CUBE-DEFAULT-CALL-WITH-FACET-2A-20MGL-PAX-3ASECTION-29" title="The Default Implementation of CALL-WITH-FACET\\*">The Default Implementation of CALL-WITH-FACET*</a> for the gory
details.</p>

<p>Specializations will most likely want to call the default
implementation (with <code>CALL-NEXT-METHOD</code>) but with a lambda that
transforms <a href="#x-28MGL-CUBE-3AFACET-VALUE-20-28MGL-PAX-3ASTRUCTURE-ACCESSOR-29-29" title="(MGL-CUBE:FACET-VALUE (MGL-PAX:STRUCTURE-ACCESSOR))"><code>FACET-VALUE</code></a> before passing it on to <code>FN</code>.</p></li>
</ul>

<p><a id='x-28MGL-CUBE-3AFACET-UP-TO-DATE-P-2A-20GENERIC-FUNCTION-29'></a></p>

<ul>
<li><p><span class="locative-type"><a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L370">[generic-function]</a></span> <span class="reference-object"><a href="#x-28MGL-CUBE-3AFACET-UP-TO-DATE-P-2A-20GENERIC-FUNCTION-29" >FACET-UP-TO-DATE-P*</a></span> <span class="locative-args">CUBE FACET-NAME FACET</span></p>

<p>Check if <code>FACET</code> with <code>FACET-NAME</code> has been updated
since the latest change to <code>CUBE</code> (that is, since the access to other
facets with <a href="#x-28MGL-CUBE-3ADIRECTION-20-28TYPE-29-29" title="(MGL-CUBE:DIRECTION (TYPE))"><code>DIRECTION</code></a> of <code>:IO</code> or <code>:OUTPUT</code>). The default method simply
calls <a href="#x-28MGL-CUBE-3AFACET-UP-TO-DATE-P-20-28MGL-PAX-3ASTRUCTURE-ACCESSOR-29-29" title="(MGL-CUBE:FACET-UP-TO-DATE-P (MGL-PAX:STRUCTURE-ACCESSOR))"><code>FACET-UP-TO-DATE-P</code></a> on <code>FACET</code>.</p>

<p>One reason to specialize this is when some facets actually share
common storage, so updating one make the other up-to-date as well.</p></li>
</ul>

<p><a id='x-28MGL-CUBE-3ASELECT-COPY-SOURCE-FOR-FACET-2A-20GENERIC-FUNCTION-29'></a></p>

<ul>
<li><p><span class="locative-type"><a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L358">[generic-function]</a></span> <span class="reference-object"><a href="#x-28MGL-CUBE-3ASELECT-COPY-SOURCE-FOR-FACET-2A-20GENERIC-FUNCTION-29" >SELECT-COPY-SOURCE-FOR-FACET*</a></span> <span class="locative-args">CUBE TO-NAME TO-FACET</span></p>

<p>Called when <code>TO-FACET</code> with <code>TO-NAME</code> is about to be
updated by copying data from an up-to-date facet. Return the
facet (or its name) from which data shall be copied. Note that if
the returned facet is not <a href="#x-28MGL-CUBE-3AFACET-UP-TO-DATE-P-20-28MGL-PAX-3ASTRUCTURE-ACCESSOR-29-29" title="(MGL-CUBE:FACET-UP-TO-DATE-P (MGL-PAX:STRUCTURE-ACCESSOR))"><code>FACET-UP-TO-DATE-P</code></a><em>, then it will be
updated first and another SELECT-COPY-SOURCE-FOR-FACET</em> will take
place, so be careful not to get into endless recursion. The default
method simply returns the first up-to-date facet.</p></li>
</ul>

<p>PAX integration follows, don't worry about it if you don't use PAX,
but you really should (see <code>MGL-PAX:@MGL-PAX-MANUAL</code>).</p>

<p><a id='x-28MGL-CUBE-3AFACET-NAME-20-28MGL-PAX-3ALOCATIVE-29-29'></a></p>

<ul>
<li><p><span class="locative-type"><a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L392">[locative]</a></span> <span class="reference-object"><a href="#x-28MGL-CUBE-3AFACET-NAME-20-28MGL-PAX-3ALOCATIVE-29-29" >FACET-NAME</a></span></p>

<p>The <code>FACET-NAME</code> [locative] is the to refer to stuff
defined with <a href="#x-28MGL-CUBE-3ADEFINE-FACET-NAME-20-28MGL-PAX-3AMACRO-29-29" title="(MGL-CUBE:DEFINE-FACET-NAME (MGL-PAX:MACRO))"><code>DEFINE-FACET-NAME</code></a>.</p></li>
</ul>

<p><a id='x-28MGL-CUBE-3ADEFINE-FACET-NAME-20-28MGL-PAX-3AMACRO-29-29'></a></p>

<ul>
<li><p><span class="locative-type"><a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L396">[macro]</a></span> <span class="reference-object"><a href="#x-28MGL-CUBE-3ADEFINE-FACET-NAME-20-28MGL-PAX-3AMACRO-29-29" >DEFINE-FACET-NAME</a></span> <span class="locative-args">SYMBOL LAMBDA-LIST &amp;BODY DOCSTRING</span></p>

<p>Just a macro to document that <code>SYMBOL</code> refers to a facet name (as in
the <a href="#x-28MGL-CUBE-3AFACET-NAME-20-28MGL-PAX-3ALOCATIVE-29-29" title="(MGL-CUBE:FACET-NAME (MGL-PAX:LOCATIVE))"><code>FACET-NAME</code></a>). This is totally confusing, so here is
an example of how MGL-MAT (see <a href="mat-manual.html#x-28MGL-MAT-3A-40MAT-MANUAL-20MGL-PAX-3ASECTION-29" title="MAT Manual">MAT Manual</a>) documents the
<a href="mat-manual.html#x-28MGL-MAT-3ABACKING-ARRAY-20-28MGL-CUBE-3AFACET-NAME-29-29" title="(MGL-MAT:BACKING-ARRAY (MGL-CUBE:FACET-NAME))"><code>MGL-MAT:BACKING-ARRAY</code></a> facet:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">define-facet-name</span></i> backing-array <span class="paren2">(<span class="code"></span>)</span>
  <span class="string">"The corresponding facet is a one dimensional lisp array."</span></span>)</span></span></code></pre>

<p>Which makes it possible to refer to this definition (refer as in
link and <code>M-.</code> to) <a href="mat-manual.html#x-28MGL-MAT-3ABACKING-ARRAY-20-28MGL-CUBE-3AFACET-NAME-29-29" title="(MGL-MAT:BACKING-ARRAY (MGL-CUBE:FACET-NAME))"><code>MGL-MAT:BACKING-ARRAY</code></a> facet-name. See
<code>MGL-PAX:@MGL-PAX-MANUAL</code> for more.</p></li>
</ul>

<p>Also see <a href="#x-28MGL-CUBE-3A-40CUBE-DEFAULT-CALL-WITH-FACET-2A-20MGL-PAX-3ASECTION-29" title="The Default Implementation of CALL-WITH-FACET\\*">The Default Implementation of CALL-WITH-FACET*</a>.</p>

<p><a id='x-28MGL-CUBE-3A-40CUBE-DEFAULT-CALL-WITH-FACET-2A-20MGL-PAX-3ASECTION-29'></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#x-28MGL-CUBE-3A-40CUBE-FACET-EXTENSION-API-20MGL-PAX-3ASECTION-29" title="Facet Extension API">&#8592;</a> <a href="#x-28MGL-CUBE-3A-40CUBE-MANUAL-20MGL-PAX-3ASECTION-29" title="Cube Manual">&#8593;</a> <a href="#x-28MGL-CUBE-3A-40CUBE-LIFETIME-20MGL-PAX-3ASECTION-29" title="Lifetime">&#8594;</a> <a href="#x-28MGL-CUBE-3A-40CUBE-DEFAULT-CALL-WITH-FACET-2A-20MGL-PAX-3ASECTION-29" title="The Default Implementation of CALL-WITH-FACET\\*">&#8634;</a> <a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L412">&#955;</a></span></span></p>

<h2><a href="#x-28MGL-CUBE-3A-40CUBE-DEFAULT-CALL-WITH-FACET-2A-20MGL-PAX-3ASECTION-29">7 The Default Implementation of CALL-WITH-FACET*</a></h2>

<p><a id='x-28MGL-CUBE-3ACALL-WITH-FACET-2A-20-28METHOD-20NIL-20-28MGL-CUBE-3ACUBE-20T-20T-20T-29-29-29'></a></p>

<ul>
<li><p><span class="locative-type"><a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L422">[method]</a></span> <span class="reference-object"><a href="#x-28MGL-CUBE-3ACALL-WITH-FACET-2A-20-28METHOD-20NIL-20-28MGL-CUBE-3ACUBE-20T-20T-20T-29-29-29" >CALL-WITH-FACET*</a></span> <span class="locative-args">(CUBE CUBE) FACET-NAME DIRECTION FN</span></p>

<p>The default implementation of <a href="#x-28MGL-CUBE-3ACALL-WITH-FACET-2A-20GENERIC-FUNCTION-29" title="(MGL-CUBE:CALL-WITH-FACET* GENERIC-FUNCTION)"><code>CALL-WITH-FACET*</code></a> is defined in terms
of the <a href="#x-28MGL-CUBE-3AWATCH-FACET-20GENERIC-FUNCTION-29" title="(MGL-CUBE:WATCH-FACET GENERIC-FUNCTION)"><code>WATCH-FACET</code></a> and the <a href="#x-28MGL-CUBE-3AUNWATCH-FACET-20GENERIC-FUNCTION-29" title="(MGL-CUBE:UNWATCH-FACET GENERIC-FUNCTION)"><code>UNWATCH-FACET</code></a> generic functions. These
can be considered part of the <a href="#x-28MGL-CUBE-3A-40CUBE-FACET-EXTENSION-API-20MGL-PAX-3ASECTION-29" title="Facet Extension API">Facet Extension API</a>.</p></li>
</ul>

<p><a id='x-28MGL-CUBE-3AWATCH-FACET-20GENERIC-FUNCTION-29'></a></p>

<ul>
<li><p><span class="locative-type"><a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L445">[generic-function]</a></span> <span class="reference-object"><a href="#x-28MGL-CUBE-3AWATCH-FACET-20GENERIC-FUNCTION-29" >WATCH-FACET</a></span> <span class="locative-args">CUBE FACET-NAME DIRECTION</span></p>

<p>This is what the default <a href="#x-28MGL-CUBE-3ACALL-WITH-FACET-2A-20GENERIC-FUNCTION-29" title="(MGL-CUBE:CALL-WITH-FACET* GENERIC-FUNCTION)"><code>CALL-WITH-FACET*</code></a> method,
in terms of which <a href="#x-28MGL-CUBE-3AWITH-FACET-20-28MGL-PAX-3AMACRO-29-29" title="(MGL-CUBE:WITH-FACET (MGL-PAX:MACRO))"><code>WITH-FACET</code></a> is implemented, calls first. The
default method takes care of creating facets, copying and tracking
up-to-dateness.</p>

<p>Calls <a href="#x-28MGL-CUBE-3ACHECK-NO-WRITERS-20FUNCTION-29" title="(MGL-CUBE:CHECK-NO-WRITERS FUNCTION)"><code>CHECK-NO-WRITERS</code></a> (unless <a href="#x-28MGL-CUBE-3A-2ALET-INPUT-THROUGH-P-2A-20-28VARIABLE-29-29" title="(MGL-CUBE:*LET-INPUT-THROUGH-P* (VARIABLE))"><code>*LET-INPUT-THROUGH-P*</code></a>) and
<a href="#x-28MGL-CUBE-3ACHECK-NO-WATCHERS-20FUNCTION-29" title="(MGL-CUBE:CHECK-NO-WATCHERS FUNCTION)"><code>CHECK-NO-WATCHERS</code></a> (unless <a href="#x-28MGL-CUBE-3A-2ALET-OUTPUT-THROUGH-P-2A-20-28VARIABLE-29-29" title="(MGL-CUBE:*LET-OUTPUT-THROUGH-P* (VARIABLE))"><code>*LET-OUTPUT-THROUGH-P*</code></a>) depending on
<code>DIRECTION</code> to detect situations with a writer being concurrent to
readers/writers because that would screw up the tracking of
up-to-dateness.</p>

<p>The default implementation should suffice most of the time.
MGL-MAT specializes it to override the <code>DIRECTION</code> arg, if
it's <code>:OUTPUT</code> but not all elements are visible due to reshaping, so
that invisible elements are still copied over.</p></li>
</ul>

<p><a id='x-28MGL-CUBE-3AUNWATCH-FACET-20GENERIC-FUNCTION-29'></a></p>

<ul>
<li><p><span class="locative-type"><a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L486">[generic-function]</a></span> <span class="reference-object"><a href="#x-28MGL-CUBE-3AUNWATCH-FACET-20GENERIC-FUNCTION-29" >UNWATCH-FACET</a></span> <span class="locative-args">CUBE FACET-NAME</span></p>

<p>This is what the default <a href="#x-28MGL-CUBE-3ACALL-WITH-FACET-2A-20GENERIC-FUNCTION-29" title="(MGL-CUBE:CALL-WITH-FACET* GENERIC-FUNCTION)"><code>CALL-WITH-FACET*</code></a> method,
in terms of which <a href="#x-28MGL-CUBE-3AWITH-FACET-20-28MGL-PAX-3AMACRO-29-29" title="(MGL-CUBE:WITH-FACET (MGL-PAX:MACRO))"><code>WITH-FACET</code></a> is implemented, calls last. The default
method takes care of taking down facets. External resource managers
may want to hook into this to handle unused facets.</p></li>
</ul>

<p><a id='x-28MGL-CUBE-3A-2ALET-INPUT-THROUGH-P-2A-20-28VARIABLE-29-29'></a></p>

<ul>
<li><p><span class="locative-type"><a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L500">[variable]</a></span> <span class="reference-object"><a href="#x-28MGL-CUBE-3A-2ALET-INPUT-THROUGH-P-2A-20-28VARIABLE-29-29" >*LET-INPUT-THROUGH-P*</a></span> <span class="locative-args">NIL</span></p>

<p>If true, <a href="#x-28MGL-CUBE-3AWITH-FACETS-20-28MGL-PAX-3AMACRO-29-29" title="(MGL-CUBE:WITH-FACETS (MGL-PAX:MACRO))"><code>WITH-FACETS</code></a> (more precisely, the default implementation of
<a href="#x-28MGL-CUBE-3ACALL-WITH-FACET-2A-20GENERIC-FUNCTION-29" title="(MGL-CUBE:CALL-WITH-FACET* GENERIC-FUNCTION)"><code>CALL-WITH-FACET*</code></a>) with <code>:DIRECTION</code> <code>:INPUT</code> does not call
<a href="#x-28MGL-CUBE-3ACHECK-NO-WRITERS-20FUNCTION-29" title="(MGL-CUBE:CHECK-NO-WRITERS FUNCTION)"><code>CHECK-NO-WRITERS</code></a>. This knob is intended to be bound locally for
debugging purposes.</p></li>
</ul>

<p><a id='x-28MGL-CUBE-3A-2ALET-OUTPUT-THROUGH-P-2A-20-28VARIABLE-29-29'></a></p>

<ul>
<li><p><span class="locative-type"><a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L506">[variable]</a></span> <span class="reference-object"><a href="#x-28MGL-CUBE-3A-2ALET-OUTPUT-THROUGH-P-2A-20-28VARIABLE-29-29" >*LET-OUTPUT-THROUGH-P*</a></span> <span class="locative-args">NIL</span></p>

<p>If true, <a href="#x-28MGL-CUBE-3AWITH-FACETS-20-28MGL-PAX-3AMACRO-29-29" title="(MGL-CUBE:WITH-FACETS (MGL-PAX:MACRO))"><code>WITH-FACETS</code></a> (more precisely, the default implementation of
<a href="#x-28MGL-CUBE-3ACALL-WITH-FACET-2A-20GENERIC-FUNCTION-29" title="(MGL-CUBE:CALL-WITH-FACET* GENERIC-FUNCTION)"><code>CALL-WITH-FACET*</code></a>) with <code>:DIRECTION</code> <code>:IO</code> or <code>:OUTPUT</code> does not call
<a href="#x-28MGL-CUBE-3ACHECK-NO-WATCHERS-20FUNCTION-29" title="(MGL-CUBE:CHECK-NO-WATCHERS FUNCTION)"><code>CHECK-NO-WATCHERS</code></a>. This knob is intended to be bound locally for
debugging purposes.</p></li>
</ul>

<p><a id='x-28MGL-CUBE-3ACHECK-NO-WRITERS-20FUNCTION-29'></a></p>

<ul>
<li><p><span class="locative-type"><a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L512">[function]</a></span> <span class="reference-object"><a href="#x-28MGL-CUBE-3ACHECK-NO-WRITERS-20FUNCTION-29" >CHECK-NO-WRITERS</a></span> <span class="locative-args">CUBE FACET-NAME MESSAGE-FORMAT &amp;REST MESSAGE-ARGS</span></p>

<p>Signal an error if <code>CUBE</code> has facets (with names other than
<code>FACET-NAME</code>) being written (i.e. direction is <code>:IO</code> or <code>:OUTPUT</code>).</p></li>
</ul>

<p><a id='x-28MGL-CUBE-3ACHECK-NO-WATCHERS-20FUNCTION-29'></a></p>

<ul>
<li><p><span class="locative-type"><a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L527">[function]</a></span> <span class="reference-object"><a href="#x-28MGL-CUBE-3ACHECK-NO-WATCHERS-20FUNCTION-29" >CHECK-NO-WATCHERS</a></span> <span class="locative-args">CUBE FACET-NAME MESSAGE-FORMAT &amp;REST MESSAGE-ARGS</span></p>

<p>Signal an error if <code>CUBE</code> has facets (with names other than
<code>FACET-NAME</code>) being regardless of the direction.</p></li>
</ul>

<p><a id='x-28MGL-CUBE-3A-40CUBE-LIFETIME-20MGL-PAX-3ASECTION-29'></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#x-28MGL-CUBE-3A-40CUBE-DEFAULT-CALL-WITH-FACET-2A-20MGL-PAX-3ASECTION-29" title="The Default Implementation of CALL-WITH-FACET\\*">&#8592;</a> <a href="#x-28MGL-CUBE-3A-40CUBE-MANUAL-20MGL-PAX-3ASECTION-29" title="Cube Manual">&#8593;</a> <a href="#x-28MGL-CUBE-3A-40CUBE-FACET-BARRIER-20MGL-PAX-3ASECTION-29" title="Facet Barriers">&#8594;</a> <a href="#x-28MGL-CUBE-3A-40CUBE-LIFETIME-20MGL-PAX-3ASECTION-29" title="Lifetime">&#8634;</a> <a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L543">&#955;</a></span></span></p>

<h2><a href="#x-28MGL-CUBE-3A-40CUBE-LIFETIME-20MGL-PAX-3ASECTION-29">8 Lifetime</a></h2>

<p>Lifetime management of facets is manual (but facets of garbage
cubes are freed automatically by a finalizer, see <a href="#x-28MGL-CUBE-3AMAKE-FACET-2A-20GENERIC-FUNCTION-29" title="(MGL-CUBE:MAKE-FACET* GENERIC-FUNCTION)"><code>MAKE-FACET*</code></a>). One
may destroy a single facet or all facets of a cube with
<a href="#x-28MGL-CUBE-3ADESTROY-FACET-20FUNCTION-29" title="(MGL-CUBE:DESTROY-FACET FUNCTION)"><code>DESTROY-FACET</code></a> and <a href="#x-28MGL-CUBE-3ADESTROY-CUBE-20FUNCTION-29" title="(MGL-CUBE:DESTROY-CUBE FUNCTION)"><code>DESTROY-CUBE</code></a>, respectively. Also see
<a href="#x-28MGL-CUBE-3A-40CUBE-FACET-BARRIER-20MGL-PAX-3ASECTION-29" title="Facet Barriers">Facet Barriers</a>.</p>

<p><a id='x-28MGL-CUBE-3ADESTROY-FACET-20FUNCTION-29'></a></p>

<ul>
<li><p><span class="locative-type"><a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L564">[function]</a></span> <span class="reference-object"><a href="#x-28MGL-CUBE-3ADESTROY-FACET-20FUNCTION-29" >DESTROY-FACET</a></span> <span class="locative-args">CUBE FACET-NAME</span></p>

<p>Free resources associated with the facet with <code>FACET-NAME</code> and remove
it from <a href="#x-28MGL-CUBE-3AFACETS-20FUNCTION-29" title="(MGL-CUBE:FACETS FUNCTION)"><code>FACETS</code></a> of <code>CUBE</code>.</p></li>
</ul>

<p><a id='x-28MGL-CUBE-3ADESTROY-CUBE-20FUNCTION-29'></a></p>

<ul>
<li><p><span class="locative-type"><a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L581">[function]</a></span> <span class="reference-object"><a href="#x-28MGL-CUBE-3ADESTROY-CUBE-20FUNCTION-29" >DESTROY-CUBE</a></span> <span class="locative-args">CUBE</span></p>

<p>Destroy all facets of <code>CUBE</code> with <a href="#x-28MGL-CUBE-3ADESTROY-FACET-20FUNCTION-29" title="(MGL-CUBE:DESTROY-FACET FUNCTION)"><code>DESTROY-FACET</code></a>.</p></li>
</ul>

<p>In some cases it is useful to declare the intent to use a facet in
the future to prevent its destruction. Hence, every facet has
reference count which starts from 0. The reference count is
incremented and decremented by <a href="#x-28MGL-CUBE-3AADD-FACET-REFERENCE-BY-NAME-20FUNCTION-29" title="(MGL-CUBE:ADD-FACET-REFERENCE-BY-NAME FUNCTION)"><code>ADD-FACET-REFERENCE-BY-NAME</code></a> and
<a href="#x-28MGL-CUBE-3AREMOVE-FACET-REFERENCE-BY-NAME-20FUNCTION-29" title="(MGL-CUBE:REMOVE-FACET-REFERENCE-BY-NAME FUNCTION)"><code>REMOVE-FACET-REFERENCE-BY-NAME</code></a>, respectively. If it is positive,
then the facet will not be destroyed by explicit <a href="#x-28MGL-CUBE-3ADESTROY-FACET-20FUNCTION-29" title="(MGL-CUBE:DESTROY-FACET FUNCTION)"><code>DESTROY-FACET</code></a> and
<a href="#x-28MGL-CUBE-3ADESTROY-CUBE-20FUNCTION-29" title="(MGL-CUBE:DESTROY-CUBE FUNCTION)"><code>DESTROY-CUBE</code></a> calls, but it will still be destroyed by the finalizer
to prevent resource leaks caused by stray references.</p>

<p><a id='x-28MGL-CUBE-3AADD-FACET-REFERENCE-BY-NAME-20FUNCTION-29'></a></p>

<ul>
<li><p><span class="locative-type"><a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L587">[function]</a></span> <span class="reference-object"><a href="#x-28MGL-CUBE-3AADD-FACET-REFERENCE-BY-NAME-20FUNCTION-29" >ADD-FACET-REFERENCE-BY-NAME</a></span> <span class="locative-args">CUBE FACET-NAME</span></p>

<p>Make sure <code>FACET-NAME</code> exists on <code>CUBE</code> and increment its reference
count. Return the <a href="#x-28MGL-CUBE-3AFACET-20CLASS-29" title="(MGL-CUBE:FACET CLASS)"><code>FACET</code></a> behind <code>FACET-NAME</code>.</p></li>
</ul>

<p><a id='x-28MGL-CUBE-3AREMOVE-FACET-REFERENCE-BY-NAME-20FUNCTION-29'></a></p>

<ul>
<li><p><span class="locative-type"><a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L598">[function]</a></span> <span class="reference-object"><a href="#x-28MGL-CUBE-3AREMOVE-FACET-REFERENCE-BY-NAME-20FUNCTION-29" >REMOVE-FACET-REFERENCE-BY-NAME</a></span> <span class="locative-args">CUBE FACET-NAME</span></p>

<p>Decrement the reference count of the facet with <code>FACET-NAME</code> of <code>CUBE</code>.
It is an error if the facet does not exists or if the reference
count becomes negative.</p></li>
</ul>

<p><a id='x-28MGL-CUBE-3AREMOVE-FACET-REFERENCE-20FUNCTION-29'></a></p>

<ul>
<li><p><span class="locative-type"><a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L610">[function]</a></span> <span class="reference-object"><a href="#x-28MGL-CUBE-3AREMOVE-FACET-REFERENCE-20FUNCTION-29" >REMOVE-FACET-REFERENCE</a></span> <span class="locative-args">FACET</span></p>

<p>Decrement the reference count of <code>FACET</code>. It is an error if the facet
is already destroyed or if the reference count becomes negative.
This function has the same purpose as
<a href="#x-28MGL-CUBE-3AREMOVE-FACET-REFERENCE-BY-NAME-20FUNCTION-29" title="(MGL-CUBE:REMOVE-FACET-REFERENCE-BY-NAME FUNCTION)"><code>REMOVE-FACET-REFERENCE-BY-NAME</code></a>, but by having a single <code>FACET</code>
argument, it's more suited for use in finalizers because it does not
keep the whole <a href="#x-28MGL-CUBE-3ACUBE-20CLASS-29" title="(MGL-CUBE:CUBE CLASS)"><code>CUBE</code></a> alive.</p></li>
</ul>

<p><a id='x-28MGL-CUBE-3A-40CUBE-FACET-BARRIER-20MGL-PAX-3ASECTION-29'></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#x-28MGL-CUBE-3A-40CUBE-LIFETIME-20MGL-PAX-3ASECTION-29" title="Lifetime">&#8592;</a> <a href="#x-28MGL-CUBE-3A-40CUBE-LIFETIME-20MGL-PAX-3ASECTION-29" title="Lifetime">&#8593;</a> <a href="#x-28MGL-CUBE-3A-40CUBE-FACET-BARRIER-20MGL-PAX-3ASECTION-29" title="Facet Barriers">&#8634;</a> <a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L626">&#955;</a></span></span></p>

<h3><a href="#x-28MGL-CUBE-3A-40CUBE-FACET-BARRIER-20MGL-PAX-3ASECTION-29">8.1 Facet Barriers</a></h3>

<p>A facility to control lifetime of facets tied to a dynamic extent.
Also see <a href="#x-28MGL-CUBE-3A-40CUBE-LIFETIME-20MGL-PAX-3ASECTION-29" title="Lifetime">Lifetime</a>.</p>

<p><a id='x-28MGL-CUBE-3AWITH-FACET-BARRIER-20-28MGL-PAX-3AMACRO-29-29'></a></p>

<ul>
<li><p><span class="locative-type"><a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L640">[macro]</a></span> <span class="reference-object"><a href="#x-28MGL-CUBE-3AWITH-FACET-BARRIER-20-28MGL-PAX-3AMACRO-29-29" >WITH-FACET-BARRIER</a></span> <span class="locative-args">(CUBE-TYPE ENSURES DESTROYS) &amp;BODY BODY</span></p>

<p>When <code>BODY</code> exits, destroy facets which:</p>

<ul>
<li><p>are of cubes with <code>CUBE-TYPE</code></p></li>
<li><p>have a facet name among <code>DESTROYS</code></p></li>
<li><p>were created in the dynamic extent of <code>BODY</code></p></li>
</ul>

<p>Before destroying the facets, it is ensured that facets with names
among <code>ENSURES</code> are up-to-date. WITH-FACET-BARRIERs can be nested, in
case of multiple barriers matching the cube's type and the created
facet's name, the innermost one takes precedence.</p>

<p>The purpose of this macro is twofold. First, it makes it easy to
temporarily work with a certain facet of many cubes without leaving
newly created facets around. Second, it can be used to make sure
that facets whose extent is tied to some dynamic boundary (such as
the thread in which they were created) are destroyed.</p></li>
</ul>

<p><a id='x-28MGL-CUBE-3ACOUNT-BARRED-FACETS-20FUNCTION-29'></a></p>

<ul>
<li><p><span class="locative-type"><a href="https://github.com/melisgl/mgl-mat/blob/2f30bb96ca70af46e2083bc01ba46614976f9151/src/cube.lisp#L719">[function]</a></span> <span class="reference-object"><a href="#x-28MGL-CUBE-3ACOUNT-BARRED-FACETS-20FUNCTION-29" >COUNT-BARRED-FACETS</a></span> <span class="locative-args">FACET-NAME &amp;KEY (TYPE '<a href="#x-28MGL-CUBE-3ACUBE-20CLASS-29" title="(MGL-CUBE:CUBE CLASS)"><code>CUBE</code></a>)</span></p>

<p>Count facets with <code>FACET-NAME</code> of cubes of <code>TYPE</code> which will be
destroyed by a facet barrier.</p></li>
</ul>
  </div>
</div>
<script>$('#page-toc').toc({'selectors': 'h1,h2,h3,h4'});</script>
</body>
</html>
